<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumi Suporte - Sistema de Chamados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="icon" href="LogoLumi.png" type="image/png">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --bg-primary: #0d1117; --bg-secondary: #161b22; --glass-bg: rgba(22, 27, 34, 0.6);
            --text-primary: #e2e8f0; --text-secondary: #9ca3af; --text-title: #00d4ff;
            --border-color: rgba(255, 255, 255, 0.1); --input-bg: #1e293b; --input-border: #334155;
            --btn-bg: #1e293b; --btn-border: #334155; --btn-hover-bg: #334155;
            --accent-orange: #ff6b35; --electric-blue: #00d4ff; --dark-overlay: rgba(10, 25, 47, 0.9);
        }
        .light-theme {
            --bg-primary: #f1f5f9; --bg-secondary: #ffffff; --glass-bg: rgba(255, 255, 255, 0.7);
            --text-primary: #0f172a; --text-secondary: #475569; --text-title: #0c7a91;
            --border-color: #e2e8f0; --input-bg: #ffffff; --input-border: #cbd5e1;
            --btn-bg: #f1f5f9; --btn-border: #cbd5e1; --btn-hover-bg: #e2e8f0;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .logo-symbol { width: 50px; height: 50px; background: linear-gradient(135deg, var(--dark-overlay), var(--dark-overlay)); border-radius: 10px; margin-right: 15px; display: flex; align-items: center; justify-content: center; position: relative; animation: glow 2s ease-in-out infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 20px var(--accent-orange); } to { box-shadow: 0 0 30px var(--electric-blue), 0 0 40px var(--electric-blue); } }
        .glass-effect { background: var(--glass-bg); backdrop-filter: blur(10px); border: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s; }
        .glow-text { text-shadow: 0 0 5px rgba(0, 212, 255, 0.5), 0 0 10px rgba(0, 212, 255, 0.5); }
        .light-theme .glow-text { text-shadow: none; }
        .action-btn { background: transparent; border: none; cursor: pointer; padding: 4px; border-radius: 50%; transition: background-color 0.2s; color: var(--text-secondary); }
        .action-btn:hover { background-color: rgba(127, 127, 127, 0.1); }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--bg-primary); } ::-webkit-scrollbar-thumb { background: #2d3748; border-radius: 4px; } .light-theme ::-webkit-scrollbar-thumb { background: #cbd5e1; }
        .custom-input, .custom-select, .custom-textarea { background-color: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-primary); border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%; }
        .light-theme .custom-input, .light-theme .custom-select, .light-theme .custom-textarea { color: var(--text-primary); }
        .custom-input::placeholder, .custom-textarea::placeholder { color: var(--text-secondary); }
        .page-btn { color: var(--text-secondary); background-color: transparent; padding: 0.5rem 1rem; border-radius: 0.375rem; transition: all 0.2s; font-weight: 500; }
        .page-btn:hover { background-color: var(--btn-hover-bg); }
        .page-btn-active { background-color: var(--text-title); color: white; box-shadow: 0 2px 10px -2px var(--text-title); }
        .status-badge { padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; text-align: center; }
        .status-resolvido, .kanban-header-resolvido { background-color: #166534; color: #dcfce7; }
        .status-andamento, .kanban-header-andamento { background-color: #854d0e; color: #fef9c3; }
        .status-pendente, .kanban-header-pendente { background-color: #991b1b; color: #fee2e2; }
        .light-theme .status-resolvido, .light-theme .kanban-header-resolvido { background-color: #dcfce7; color: #166534; }
        .light-theme .status-andamento, .light-theme .kanban-header-andamento { background-color: #fef9c3; color: #854d0e; }
        .light-theme .status-pendente, .light-theme .kanban-header-pendente { background-color: #fee2e2; color: #991b1b; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .modal-label { color: var(--text-secondary); } .light-theme .modal-label { color: var(--text-primary); }
        .view-btn { padding: 6px 12px; border-radius: 6px; font-size: 0.875rem; font-weight: 500; transition: all 0.2s; border: 1px solid transparent; }
        .view-btn-active { background-color: var(--text-title); color: white; }
        .kanban-column { min-height: 400px; }
        .kanban-card { cursor: grab; } .kanban-card:active { cursor: grabbing; }
        .kanban-column.drag-over { background-color: rgba(0, 212, 255, 0.1); border-style: dashed; }
        .dragging { opacity: 0.5; }
        .chart-container { position: relative; height: 350px; width: 100%; }
        .filter-btn-active { background-color: var(--text-title) !important; color: white; }
    </style>
</head>
<body class="min-h-screen">
    <!-- PÁGINA DE LOGIN -->
    <div id="loginPage" class="flex items-center justify-center min-h-screen"><div class="glass-effect p-8 rounded-lg shadow-2xl w-full max-w-sm"><div class="flex items-center justify-center gap-4 mb-8">
       <div class="logo-symbol">
                <img src="LogoLumi.png" alt="Logo Lumitech" style="width: 38px; height: 38px; object-fit: contain; position: absolute; left: 6px; top: 6px; z-index: 2; pointer-events: none;" />
               </div>
        <h1 class="text-3xl font-bold font-orbitron glow-text">Lumi Suporte</h1></div><form id="loginForm" class="space-y-6"><div><label for="username" class="modal-label block text-sm font-medium">Usuário</label><input type="text" id="username" class="custom-input mt-1" placeholder="admin" value="admin"></div><div><label for="password" class="modal-label block text-sm font-medium">Senha</label><input type="password" id="password" class="custom-input mt-1" placeholder="••••••••" value="lumi10"></div><button type="submit" class="w-full justify-center py-2 px-4 border-transparent rounded-md text-white bg-blue-600 hover:bg-blue-700">Entrar</button></form></div></div>

    <!-- APLICAÇÃO PRINCIPAL -->
    <div id="app-wrapper" class="hidden container mx-auto px-4 sm:px-6 lg:px-8 max-w-full">
        <header class="flex items-center justify-between gap-4 mb-6 pt-4 sm:pt-6"><div class="flex items-center gap-4">
            <div class="logo-symbol">
                <img src="LogoLumi.png" alt="Logo Lumitech" style="width: 38px; height: 38px; object-fit: contain; position: absolute; left: 6px; top: 6px; z-index: 2; pointer-events: none;" />
               </div>
            <h1 class="text-3xl sm:text-4xl font-bold font-orbitron glow-text">Lumi Suporte</h1></div><div class="flex items-center gap-4"><button id="themeToggleBtn" class="action-btn p-2 rounded-full" title="Alternar tema"><svg id="theme-icon-sun" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg><svg id="theme-icon-moon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg></button><button id="logoutBtn" class="action-btn p-2 rounded-full" title="Sair"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z"/><path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"/></svg></button></div></header>
        <nav class="mb-8 p-2 glass-effect rounded-lg flex items-center justify-center sm:justify-start gap-2 flex-wrap"><button id="pageAtendenteBtn" class="page-btn page-btn-active">Atendente</button><button id="pageChamadosBtn" class="page-btn">Chamados</button><button id="pageDashboardBtn" class="page-btn">Dashboard</button></nav>
        <main id="app-content">
            <div id="atendentePage"><div class="glass-effect rounded-lg"><div class="p-4 flex justify-between items-center border-b" style="border-color: var(--border-color);"><h2 class="text-xl font-semibold font-orbitron">Atendimento via Chatbot</h2><button id="reiniciarChatBtn" class="bg-blue-600 text-white px-3 py-1.5 rounded-md font-semibold hover:bg-blue-700 transition">Reiniciar Chat</button></div><div class="p-4"><iframe id="typebot-iframe" src="https://lumitechia-typebot-viewer.aeenwc.easypanel.host/abertura-de-chamado" class="w-full h-[70vh] rounded-lg" style="border:0;"></iframe></div></div></div>
            <div id="chamadosPage" class="hidden">
                <div class="glass-effect p-4 sm:p-6 rounded-lg">
                    <!-- MODIFICADO: Adicionado filtro por código e botão de atualizar -->
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-5 gap-4 flex-wrap">
                        <div class="flex flex-col sm:flex-row sm:flex-wrap items-center gap-2 w-full flex-grow">
                            <input type="search" id="searchCodigoChamadoInput" placeholder="Pesquisar por Cód. Chamado..." class="custom-input sm:w-auto flex-grow">
                            <input type="search" id="searchChamadoInput" placeholder="Pesquisar por cliente..." class="custom-input sm:w-auto flex-grow">
                            <select id="filterTipo" class="custom-select sm:w-auto flex-grow-0"><option value="todos">Todos os Tipos</option><option>Vendas</option><option>Suporte Técnico</option><option>Financeiro</option><option>Outros</option></select>
                            <select id="filterStatus" class="custom-select sm:w-auto flex-grow-0"><option value="todos">Todos Status</option><option>Pendente</option><option>Em Andamento</option><option>Resolvido</option></select>
                        </div>
                        <div class="flex flex-col sm:flex-row items-center gap-4 w-full sm:w-auto">
                            <div id="viewToggleButtons" class="flex items-center gap-1 rounded-md p-1" style="background-color: var(--btn-bg);"><button id="viewListBtn" class="view-btn view-btn-active">Lista</button><button id="viewKanbanBtn" class="view-btn">Kanban</button></div>
                            <button id="updateListBtn" class="w-full sm:w-auto flex-shrink-0 bg-gray-600 text-white px-3 py-2 rounded-md font-semibold hover:bg-gray-700 transition" title="Atualizar Lista">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="pointer-events-none" viewBox="0 0 16 16">
                                  <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                                  <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
                                </svg>
                            </button>
                            <button id="addChamadoBtn" class="w-full sm:w-auto flex-shrink-0 bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700 transition">Novo Chamado</button>
                        </div>
                    </div>
                    <div id="listViewContainer"><div class="overflow-x-auto"><table class="min-w-full"><thead class="border-b" style="border-color: var(--border-color);"><tr><th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Cód. Chamado</th><th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Cliente</th><th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Tipo</th><th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Data Abertura</th><th class="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider">Tempo p/ Resolução</th><th class="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider">Status</th><th class="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider">Ações</th></tr></thead><tbody id="chamadosList"></tbody></table></div></div>
                    <div id="kanbanViewContainer" class="hidden"><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="kanban-column" data-status="Pendente"><h2 class="kanban-header-pendente text-lg font-semibold p-3 rounded-t-lg text-center">Pendente</h2><div id="kanban-col-pendente" class="p-3 space-y-4 rounded-b-lg border border-t-0" style="border-color: var(--border-color);"></div></div><div class="kanban-column" data-status="Em Andamento"><h2 class="kanban-header-andamento text-lg font-semibold p-3 rounded-t-lg text-center">Em Andamento</h2><div id="kanban-col-andamento" class="p-3 space-y-4 rounded-b-lg border border-t-0" style="border-color: var(--border-color);"></div></div><div class="kanban-column" data-status="Resolvido"><h2 class="kanban-header-resolvido text-lg font-semibold p-3 rounded-t-lg text-center">Resolvido</h2><div id="kanban-col-resolvido" class="p-3 space-y-4 rounded-b-lg border border-t-0" style="border-color: var(--border-color);"></div></div></div></div>
                </div>
            </div>
            <div id="dashboardPage" class="hidden">
                 <div class="glass-effect p-4 rounded-lg mb-8 flex flex-col sm:flex-row items-center gap-4 justify-between flex-wrap">
                     <div class="w-full sm:w-auto flex flex-col sm:flex-row gap-4 items-center"><div class="flex items-center gap-2 w-full"><label for="dashboardFilterStartDate" class="text-sm">De:</label><input type="date" id="dashboardFilterStartDate" class="custom-input w-full"></div><div class="flex items-center gap-2 w-full"><label for="dashboardFilterEndDate" class="text-sm">Até:</label><input type="date" id="dashboardFilterEndDate" class="custom-input w-full"></div></div>
                     <div class="flex items-center gap-4"><div id="dashboardFilterButtons" class="flex items-center gap-2 rounded-md p-1" style="background-color: var(--btn-bg);"><button data-period="today" class="px-3 py-1 text-sm rounded-md" style="background-color: var(--btn-bg);">Hoje</button><button data-period="week" class="px-3 py-1 text-sm rounded-md" style="background-color: var(--btn-bg);">Últimos 7 dias</button><button data-period="month" class="px-3 py-1 text-sm rounded-md" style="background-color: var(--btn-bg);">Últimos 30 dias</button></div><button id="generateReportBtn" class="bg-green-600 text-white px-3 py-1.5 rounded-md font-semibold hover:bg-green-700 transition">Gerar Relatório</button></div>
                 </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"><div class="glass-effect p-4 rounded-lg"><h3 class="text-sm font-semibold text-gray-400">TOTAL DE CHAMADOS</h3><p id="kpiTotalChamados" class="text-3xl font-bold font-orbitron"></p></div><div class="glass-effect p-4 rounded-lg"><h3 class="text-sm font-semibold text-gray-400">CHAMADOS RESOLVIDOS</h3><p id="kpiResolvidos" class="text-3xl font-bold font-orbitron"></p></div><div class="glass-effect p-4 rounded-lg"><h3 class="text-sm font-semibold text-gray-400">PENDENTES / EM ANDAMENTO</h3><p id="kpiPendentes" class="text-3xl font-bold font-orbitron"></p></div><div class="glass-effect p-4 rounded-lg"><h3 class="text-sm font-semibold text-gray-400">TEMPO MÉDIO RESOLUÇÃO</h3><p id="kpiTempoMedio" class="text-3xl font-bold font-orbitron"></p></div></div>
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8"><div class="glass-effect p-6 rounded-lg"><h3 class="font-semibold mb-4 text-center">Chamados por Tipo</h3><div class="chart-container"><canvas id="chamadosPorTipoChart"></canvas></div></div><div class="glass-effect p-6 rounded-lg"><h3 class="font-semibold mb-4 text-center">Distribuição de Status</h3><div class="chart-container"><canvas id="distribuicaoStatusChart"></canvas></div></div></div>
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8"><div class="glass-effect p-6 rounded-lg"><h3 class="font-semibold mb-4 text-center">Volume de Chamados no Período</h3><div class="chart-container"><canvas id="volumeChamadosChart"></canvas></div></div><div class="glass-effect p-6 rounded-lg"><h3 class="font-semibold mb-4 text-center">Resoluções por Dia da Semana</h3><div class="chart-container"><canvas id="resolucaoPorDiaChart"></canvas></div></div></div>
            </div>
        </main>
    </div>

    <!-- MODAIS -->
    <div id="addEditModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50 p-4"><div class="glass-effect p-8 rounded-lg shadow-2xl w-full max-w-lg"><h2 id="modalTitle" class="text-2xl font-semibold mb-5 font-orbitron" style="color: var(--text-title);"></h2><form id="addEditForm" class="space-y-4"><input type="hidden" id="edit-id"><div><label class="modal-label block text-sm font-medium">Nome do Cliente</label><input type="text" id="edit-nomeCliente" required class="custom-input mt-1"></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label class="modal-label block text-sm font-medium">Telefone</label><input type="tel" id="edit-telefone" class="custom-input mt-1"></div><div><label class="modal-label block text-sm font-medium">E-mail</label><input type="email" id="edit-email" class="custom-input mt-1"></div></div><div><label class="modal-label block text-sm font-medium">Tipo de Chamado</label><select id="edit-tipo" required class="custom-select mt-1"><option>Vendas</option><option>Suporte Técnico</option><option>Financeiro</option><option>Outros</option></select></div><div><label class="modal-label block text-sm font-medium">Descrição</label><textarea id="edit-descricao" required class="custom-textarea mt-1" rows="4"></textarea></div><div class="flex gap-4 pt-4"><button type="button" id="cancelEdit" class="w-full justify-center py-2 px-4 border rounded-md shadow-sm text-sm" style="border-color: var(--input-border); color: var(--text-primary); background-color: var(--btn-bg);">Cancelar</button><button type="submit" class="w-full justify-center py-2 px-4 border-transparent rounded-md shadow-sm text-sm text-white bg-blue-600 hover:bg-blue-700">Salvar</button></div></form></div></div>
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50"><div class="glass-effect p-8 rounded-lg shadow-2xl w-full max-w-md text-center"><h2 class="text-2xl font-semibold mb-5 text-yellow-400 font-orbitron">Confirmar Exclusão</h2><p class="mb-6">Tem certeza de que deseja apagar este chamado? Esta ação não pode ser desfeita.</p><div class="flex gap-4 pt-4"><button type="button" id="cancelDelete" class="w-full justify-center py-2 px-4 border rounded-md shadow-sm text-sm" style="border-color: var(--input-border); color: var(--text-primary); background-color: var(--btn-bg);">Cancelar</button><button type="button" id="confirmDelete" class="w-full justify-center py-2 px-4 border-transparent rounded-md shadow-sm text-sm text-white bg-red-600 hover:bg-red-700">Apagar</button></div></div></div>
    <div id="logoutModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50"><div class="glass-effect p-8 rounded-lg shadow-2xl w-full max-w-md text-center"><h2 class="text-2xl font-semibold mb-5 font-orbitron">Sair do Sistema</h2><p class="mb-6">Tem certeza de que deseja sair?</p><div class="flex gap-4 pt-4"><button type="button" id="cancelLogout" class="w-full justify-center py-2 px-4 border rounded-md shadow-sm text-sm" style="border-color: var(--input-border); color: var(--text-primary); background-color: var(--btn-bg);">Cancelar</button><button type="button" id="confirmLogout" class="w-full justify-center py-2 px-4 border-transparent rounded-md shadow-sm text-sm text-white bg-red-600 hover:bg-red-700">Sair</button></div></div></div>
    <div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50 p-4"><div class="glass-effect p-8 rounded-lg shadow-2xl w-full max-w-2xl"><h2 class="text-2xl font-semibold mb-5 font-orbitron" style="color: var(--text-title);">Detalhes do Chamado</h2><div id="detailsModalContent" class="space-y-3 text-sm max-h-[60vh] overflow-y-auto pr-2"></div><div class="flex justify-end gap-4 pt-6"><button type="button" id="closeDetailsModalBtn" class="w-full sm:w-auto justify-center py-2 px-4 border rounded-md shadow-sm text-sm" style="border-color: var(--input-border); color: var(--text-primary); background-color: var(--btn-bg);">Fechar</button></div></div></div>
    <div id="reportModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50 p-4"><div class="glass-effect p-8 rounded-lg shadow-2xl w-full max-w-lg"><h2 class="text-2xl font-semibold mb-5 font-orbitron" style="color: var(--text-title);">Gerar Relatório de Chamados</h2><form id="reportForm" class="space-y-4"><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label class="modal-label block text-sm font-medium">Data Inicial</label><input type="date" id="reportStartDate" class="custom-input mt-1" required></div><div><label class="modal-label block text-sm font-medium">Data Final</label><input type="date" id="reportEndDate" class="custom-input mt-1" required></div></div><div><label class="modal-label block text-sm font-medium">Filtrar por Tipo</label><select id="reportTypeFilter" class="custom-select mt-1"><option value="todos">Todos os Tipos</option><option>Vendas</option><option>Suporte Técnico</option><option>Financeiro</option><option>Outros</option></select></div><div><label class="modal-label block text-sm font-medium">Filtrar por Status</label><select id="reportStatusFilter" class="custom-select mt-1"><option value="todos">Todos os Status</option><option>Pendente</option><option>Em Andamento</option><option>Resolvido</option></select></div><div class="flex gap-4 pt-4"><button type="button" id="cancelReportBtn" class="w-full justify-center py-2 px-4 border rounded-md" style="border-color: var(--input-border); color: var(--text-primary); background-color: var(--btn-bg);">Cancelar</button><button type="submit" class="w-full justify-center py-2 px-4 border-transparent rounded-md text-white bg-blue-600 hover:bg-blue-700">Gerar PDF</button></div></form></div></div>
<script type="module">
    const { jsPDF } = window.jspdf;
    
    // --- Dados de teste removidos ---
    let mockChamados = [];
    
    // --- Conexão com NocoDB ---
    const NOCODB_HOST = 'https://lumitechia-nocodb-portfolio.aeenwc.easypanel.host/';
    const NOCODB_TOKEN = 'hIkGFs24vX_-s2YDrUX0Dnb5D64b_F9t8xE1D6Fp';
    const PROJECT_NAME = 'Portfolio'; 
    const TABLE_NAME = 'Agendamentos';
    // CORREÇÃO CRÍTICA: Usando o ID da Tabela na URL, conforme exigido pela API.
    const NOCODB_API_URL = `${NOCODB_HOST}/api/v1/db/data/noco/${PROJECT_NAME}/${TABLE_NAME}`;

    const api = {
        async getChamados() {
            try {
                const response = await fetch(`${NOCODB_API_URL}?limit=1000`, {
                    headers: { 'xc-token': NOCODB_TOKEN }
                });
                if (!response.ok) throw new Error(`${response.status}: ${response.statusText}`);
                const data = await response.json();
                return { list: data.list.map(item => ({...item, id: item.Id})) };
            } catch (error) {
                console.error("Erro ao buscar chamados:", error);
                alert(`Falha ao carregar dados do NocoDB. ${error.message}`);
                return { list: [] };
            }
        },
        async postChamado(data) {
            try {
                const response = await fetch(NOCODB_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'xc-token': NOCODB_TOKEN },
                    body: JSON.stringify(data)
                });
                if (!response.ok) throw new Error(`${response.status}: ${response.statusText}`);
                return await response.json();
            } catch (error) {
                console.error("Erro ao criar chamado:", error);
                alert(`Falha ao criar chamado. ${error.message}`);
            }
        },
        // DENTRO DO OBJETO 'api'

async patchChamado(id, data) {
     try {
        // URL CORRIGIDA: Adiciona o ID do registro ao final da URL
        const response = await fetch(`${NOCODB_API_URL}/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'xc-token': NOCODB_TOKEN },
            // CORPO CORRIGIDO: Envia apenas os dados a serem atualizados
            body: JSON.stringify(data)
        });
        if (!response.ok) {
            const errorBody = await response.json();
            console.error("Erro na API (patchChamado):", response.statusText, errorBody);
            throw new Error(`${response.status}: ${errorBody.msg}`);
        }
        return await response.json();
    } catch (error) {
        console.error("Erro ao atualizar chamado:", error);
        alert(`Falha ao atualizar chamado. ${error.message}`);
        throw error;
    }
},
async deleteChamado(id) {
    try {
        // URL CORRIGIDA: Adiciona o ID do registro ao final da URL
        const response = await fetch(`${NOCODB_API_URL}/${id}`, {
            method: 'DELETE',
            headers: { 'xc-token': NOCODB_TOKEN }
            // CORPO CORRIGIDO: Removido, pois o ID já está na URL
        });
        if (!response.ok) {
             const errorBody = await response.json();
            console.error("Erro na API (deleteChamado):", response.statusText, errorBody);
            throw new Error(`Erro na API DELETE: ${errorBody.msg}`);
        }
        return { success: true }; 
    } catch (error) {
        console.error("Erro ao deletar chamado:", error);
        alert(`Falha ao deletar chamado. ${error.message}`);
    }
}
    };

    let allChamados = [];
    let charts = {};
    
    const pageAtendenteBtn = document.getElementById('pageAtendenteBtn'), pageChamadosBtn = document.getElementById('pageChamadosBtn'), pageDashboardBtn = document.getElementById('pageDashboardBtn');
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    const sunIcon = document.getElementById('theme-icon-sun'), moonIcon = document.getElementById('theme-icon-moon');
    const addChamadoBtn = document.getElementById('addChamadoBtn');
    const addEditModal = document.getElementById('addEditModal'), modalTitle = document.getElementById('modalTitle'), addEditForm = document.getElementById('addEditForm'), cancelEdit = document.getElementById('cancelEdit');
    const deleteModal = document.getElementById('deleteModal'), cancelDelete = document.getElementById('cancelDelete'), confirmDelete = document.getElementById('confirmDelete');
    const chamadosList = document.getElementById('chamadosList');
    const searchCodigoChamadoInput = document.getElementById('searchCodigoChamadoInput'), searchChamadoInput = document.getElementById('searchChamadoInput'), filterTipo = document.getElementById('filterTipo'), filterStatus = document.getElementById('filterStatus');
    const loginPage = document.getElementById('loginPage'), appWrapper = document.getElementById('app-wrapper'), loginForm = document.getElementById('loginForm'), logoutBtn = document.getElementById('logoutBtn');
    const logoutModal = document.getElementById('logoutModal'), cancelLogout = document.getElementById('cancelLogout'), confirmLogout = document.getElementById('confirmLogout');
    const viewListBtn = document.getElementById('viewListBtn'), viewKanbanBtn = document.getElementById('viewKanbanBtn');
    const listViewContainer = document.getElementById('listViewContainer'), kanbanViewContainer = document.getElementById('kanbanViewContainer');
    const kanbanColPendente = document.getElementById('kanban-col-pendente'), kanbanColAndamento = document.getElementById('kanban-col-andamento'), kanbanColResolvido = document.getElementById('kanban-col-resolvido');
    const detailsModal = document.getElementById('detailsModal'), detailsModalContent = document.getElementById('detailsModalContent'), closeDetailsModalBtn = document.getElementById('closeDetailsModalBtn');
    const atendentePage = document.getElementById('atendentePage'), dashboardPage = document.getElementById('dashboardPage');
    const dashboardFilterStartDate = document.getElementById('dashboardFilterStartDate'), dashboardFilterEndDate = document.getElementById('dashboardFilterEndDate');
    const dashboardFilterButtons = document.getElementById('dashboardFilterButtons');
    const generateReportBtn = document.getElementById('generateReportBtn'), reportModal = document.getElementById('reportModal'), reportForm = document.getElementById('reportForm'), cancelReportBtn = document.getElementById('cancelReportBtn');
    const reiniciarChatBtn = document.getElementById('reiniciarChatBtn');
    const updateListBtn = document.getElementById('updateListBtn');
    
    const getStatusInfo = (status) => { switch (status) { case 'Resolvido': return { text: 'Resolvido', class: 'status-resolvido' }; case 'Em Andamento': return { text: 'Em Andamento', class: 'status-andamento' }; case 'Pendente': default: return { text: 'Pendente', class: 'status-pendente' }; } };
    const generateChamadoCode = () => `LUMI-${Math.random().toString(36).substring(2, 8).toUpperCase()}`;
    const calculateResolutionTime = (startDate, endDate, returnRawDays = false) => { if (!endDate) return returnRawDays ? null : 'N/A'; const start = new Date(startDate); const end = new Date(endDate); const diffTime = Math.abs(end - start); const diffDays = diffTime / (1000 * 60 * 60 * 24); if(returnRawDays) return diffDays; if (diffDays < 1) return '< 1 dia'; const roundedDays = Math.ceil(diffDays); return `${roundedDays} dia${roundedDays > 1 ? 's' : ''}`; };
    
    const renderChamadosView = (chamados) => {
        chamadosList.innerHTML = chamados.length ? chamados.map(c => {
            const statusInfo = getStatusInfo(c.status);
            const resolutionTime = calculateResolutionTime(c.dataAbertura, c.dataConclusao);
            return `
            <tr class="border-b" style="border-color: var(--border-color);">
                <td class="px-4 py-3 text-sm font-mono">${c.codigoChamado}</td>
                <td class="px-4 py-3 text-sm">
                    <div class="font-medium">${c.nomeCliente}</div>
                    <div class="text-xs text-gray-400">${c.email || c.telefone}</div>
                </td>
                <td class="px-4 py-3 text-sm text-gray-400">${c.tipo}</td>
                <td class="px-4 py-3 text-sm text-gray-400">${new Date(c.dataAbertura).toLocaleDateString('pt-BR')}</td>
                <td class="px-4 py-3 text-sm text-gray-400 text-center">${resolutionTime}</td>
                <td class="px-4 py-3 text-sm text-center"><span class="status-badge ${statusInfo.class}"><span class="status-dot" style="background-color: currentColor;"></span>${statusInfo.text}</span></td>
                <td class="px-4 py-3 text-center">
                    <div class="flex items-center justify-center gap-1">
                        <select class="custom-select text-xs status-changer" data-id="${c.id}" style="padding: 4px 8px; width: auto;">
                            <option value="Pendente" ${c.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                            <option value="Em Andamento" ${c.status === 'Em Andamento' ? 'selected' : ''}>Em Andamento</option>
                            <option value="Resolvido" ${c.status === 'Resolvido' ? 'selected' : ''}>Resolvido</option>
                        </select>
                        ${c.telefone ? `<a href="https://wa.me/55${c.telefone.replace(/\D/g, '')}" target="_blank" class="action-btn" title="WhatsApp"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="text-green-500" viewBox="0 0 16 16"><path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943s-.182-.15-.38-.25"/></svg></a>` : ''}
                        <button class="action-btn view-details-btn" data-id="${c.id}" title="Ver Detalhes"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="pointer-events-none text-gray-400" viewBox="0 0 16 16"><path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5s3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5s-3.879-1.168-5.168-2.457A13 13 0 0 1 1.172 8z"/><path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5M4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0"/></svg></button>
                        <button class="action-btn edit-btn" data-item='${JSON.stringify(c)}' title="Editar"><svg class="pointer-events-none text-blue-400" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V12h2.293z"/></svg></button>
                        <button class="action-btn delete-btn" data-id="${c.id}" title="Apagar"><svg class="pointer-events-none text-red-400" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg></button>
                    </div>
                </td>
            </tr>`;
        }).join('') : `<tr><td colspan="7" class="p-4 text-center">Nenhum chamado encontrado.</td></tr>`;
    };
    
    const renderKanbanView = (chamados) => {
        const pendentes = chamados.filter(c => c.status === 'Pendente');
        const emAndamento = chamados.filter(c => c.status === 'Em Andamento');
        const resolvidos = chamados.filter(c => c.status === 'Resolvido');

        document.querySelector('.kanban-column[data-status="Pendente"] h2').textContent = `Pendente (${pendentes.length})`;
        document.querySelector('.kanban-column[data-status="Em Andamento"] h2').textContent = `Em Andamento (${emAndamento.length})`;
        document.querySelector('.kanban-column[data-status="Resolvido"] h2').textContent = `Resolvido (${resolvidos.length})`;

        const renderColumn = (columnEl, chamados) => {
            columnEl.innerHTML = chamados.map(c => {
                const statusInfo = getStatusInfo(c.status);
                const resolutionTime = calculateResolutionTime(c.dataAbertura, c.dataConclusao);
                return `
                    <div class="kanban-card glass-effect p-4 rounded-lg space-y-2" draggable="true" data-id="${c.id}">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-mono">${c.codigoChamado}</span>
                                <span class="status-badge ${statusInfo.class}" style="font-size: 0.65rem; padding: 2px 6px;">${c.tipo}</span>
                            </div>
                            <div class="flex items-center gap-1">
                                ${c.telefone ? `<a href="https://wa.me/55${c.telefone.replace(/\D/g, '')}" target="_blank" class="action-btn" title="WhatsApp"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="text-green-500" viewBox="0 0 16 16"><path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943s-.182-.15-.38-.25"/></svg></a>` : ''}
                            <button class="action-btn view-details-btn" data-id="${c.id}" title="Ver Detalhes"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="pointer-events-none text-gray-400" viewBox="0 0 16 16"><path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5s3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5s-3.879-1.168-5.168-2.457A13 13 0 0 1 1.172 8z"/><path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5M4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0"/></svg></button>
                        </div>
                    </div>
                    <p class="font-semibold">${c.nomeCliente}</p>
                    ${c.dataConclusao ? `<p class="text-xs text-green-400">Resolvido em: ${resolutionTime}</p>` : `<p class="text-xs text-gray-400">Aberto em: ${new Date(c.dataAbertura).toLocaleDateString('pt-BR')}</p>`}
                </div>`;
            }).join('');
        };
        
        renderColumn(kanbanColPendente, pendentes);
        renderColumn(kanbanColAndamento, emAndamento);
        renderColumn(kanbanColResolvido, resolvidos);
    };
    
    const renderDashboard = (chamados) => { const resolvidos = chamados.filter(c => c.status === 'Resolvido'); const pendentes = chamados.filter(c => c.status !== 'Resolvido'); document.getElementById('kpiTotalChamados').textContent = chamados.length; document.getElementById('kpiResolvidos').textContent = resolvidos.length; document.getElementById('kpiPendentes').textContent = pendentes.length; const tempos = resolvidos.map(c => calculateResolutionTime(c.dataAbertura, c.dataConclusao, true)).filter(t => t !== null); const tempoMedio = tempos.length > 0 ? (tempos.reduce((a, b) => a + b, 0) / tempos.length).toFixed(1) : 0; document.getElementById('kpiTempoMedio').textContent = `${tempoMedio} dias`; const renderChart = (id, type, data, options) => { if (charts[id]) charts[id].destroy(); const ctx = document.getElementById(id); if (ctx) { charts[id] = new Chart(ctx.getContext('2d'), { type, data, options }); } }; const chartColors = ['#00d4ff', '#ff6b35', '#22c55e', '#facc15', '#a855f7', '#ec4899']; const chartOptions = (isDarkMode) => ({ responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: isDarkMode ? '#e2e8f0' : '#475569' } } } }); const porTipo = chamados.reduce((acc, c) => { acc[c.tipo] = (acc[c.tipo] || 0) + 1; return acc; }, {}); renderChart('chamadosPorTipoChart', 'doughnut', { labels: Object.keys(porTipo), datasets: [{ data: Object.values(porTipo), backgroundColor: chartColors, borderWidth: 0 }] }, chartOptions(localStorage.getItem('theme') !== 'light')); const porStatus = chamados.reduce((acc, c) => { acc[c.status] = (acc[c.status] || 0) + 1; return acc; }, {}); const statusColors = {'Pendente': '#ef4444', 'Em Andamento': '#f97316', 'Resolvido': '#22c55e'}; renderChart('distribuicaoStatusChart', 'doughnut', { labels: Object.keys(porStatus), datasets: [{ data: Object.values(porStatus), backgroundColor: Object.keys(porStatus).map(status => statusColors[status]), borderWidth: 0 }] }, chartOptions(localStorage.getItem('theme') !== 'light')); const volumePorDia = chamados.reduce((acc, c) => { const data = new Date(c.dataAbertura).toLocaleDateString('pt-BR'); acc[data] = (acc[data] || 0) + 1; return acc; }, {}); const sortedVolume = Object.entries(volumePorDia).sort((a,b) => new Date(a[0].split('/').reverse().join('-')) - new Date(b[0].split('/').reverse().join('-'))); renderChart('volumeChamadosChart', 'bar', { labels: sortedVolume.map(item => item[0]), datasets: [{ label: 'Chamados Abertos', data: sortedVolume.map(item => item[1]), backgroundColor: '#00d4ff' }] }, { ...chartOptions(localStorage.getItem('theme') !== 'light'), scales: { x: { ticks: { color: localStorage.getItem('theme') === 'light' ? '#475569' : '#e2e8f0' } }, y: { ticks: { color: localStorage.getItem('theme') === 'light' ? '#475569' : '#e2e8f0' } } } }); const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb']; const resPorDia = Array(7).fill(0); resolvidos.forEach(c => { const dia = new Date(c.dataConclusao).getDay(); resPorDia[dia]++; }); renderChart('resolucaoPorDiaChart', 'bar', { labels: diasSemana, datasets: [{ label: 'Chamados Resolvidos', data: resPorDia, backgroundColor: 'rgba(255, 107, 53, 0.7)' }] }, { ...chartOptions(localStorage.getItem('theme') !== 'light'), scales: { x: { ticks: { color: localStorage.getItem('theme') === 'light' ? '#475569' : '#e2e8f0' } }, y: { ticks: { color: localStorage.getItem('theme') === 'light' ? '#475569' : '#e2e8f0' } } } }); };

    // CORREÇÃO: Lógica de filtros ajustada para usar as variáveis corretas.
    const applyFiltersAndRender = () => {
        let filteredChamados = [...allChamados];
        const codigoSearchTerm = searchCodigoChamadoInput.value.toLowerCase();
        const clienteSearchTerm = searchChamadoInput.value.toLowerCase();
        const tipoFilter = filterTipo.value;
        const statusFilter = filterStatus.value;
    
        if (codigoSearchTerm) {
            filteredChamados = filteredChamados.filter(c => c.codigoChamado && c.codigoChamado.toLowerCase().includes(codigoSearchTerm));
        }
        if (clienteSearchTerm) {
            filteredChamados = filteredChamados.filter(c => c.nomeCliente.toLowerCase().includes(clienteSearchTerm));
        }
        if (tipoFilter !== 'todos') {
            filteredChamados = filteredChamados.filter(c => c.tipo === tipoFilter);
        }
        if (statusFilter !== 'todos') {
            filteredChamados = filteredChamados.filter(c => c.status === statusFilter);
        }
    
        const sorted = filteredChamados.sort((a,b) => new Date(b.dataAbertura) - new Date(a.dataAbertura));
        renderChamadosView(sorted);
        renderKanbanView(sorted);
        
        let dashboardChamados = [...allChamados];
        const startDate = dashboardFilterStartDate.value ? new Date(dashboardFilterStartDate.value + 'T00:00:00') : null;
        const endDate = dashboardFilterEndDate.value ? new Date(dashboardFilterEndDate.value + 'T23:59:59') : null;
        if(startDate) dashboardChamados = dashboardChamados.filter(c => new Date(c.dataAbertura) >= startDate);
        if(endDate) dashboardChamados = dashboardChamados.filter(c => new Date(c.dataAbertura) <= endDate);
        renderDashboard(dashboardChamados);
    };
    
    const loadData = async () => {
        const icon = updateListBtn.querySelector('svg');
        icon.classList.add('animate-spin');
        try {
            const chamados = await api.getChamados();
            allChamados = chamados.list || [];
            applyFiltersAndRender();
        } catch (error) {
            console.error("Erro ao carregar dados:", error);
        } finally {
            setTimeout(() => icon.classList.remove('animate-spin'), 500);
        }
    };
    
    const switchView = (view) => {
        if (view === 'list') {
            listViewContainer.classList.remove('hidden');
            kanbanViewContainer.classList.add('hidden');
            viewListBtn.classList.add('view-btn-active');
            viewKanbanBtn.classList.remove('view-btn-active');
        } else {
            listViewContainer.classList.add('hidden');
            kanbanViewContainer.classList.remove('hidden');
            viewListBtn.classList.remove('view-btn-active');
            viewKanbanBtn.classList.add('view-btn-active');
        }
    };
    
    const switchPage = (pageId) => {
        ['Atendente', 'Chamados', 'Dashboard'].forEach(p => {
            const page = document.getElementById(`${p.toLowerCase()}Page`);
            const btn = document.getElementById(`page${p}Btn`);
            if(page) page.classList.add('hidden');
            if(btn) btn.classList.remove('page-btn-active');
        });
        document.getElementById(`${pageId.toLowerCase()}Page`).classList.remove('hidden');
        document.getElementById(`page${pageId}Btn`).classList.add('page-btn-active');
    };

    pageAtendenteBtn.addEventListener('click', () => switchPage('Atendente'));
    pageChamadosBtn.addEventListener('click', () => switchPage('Chamados'));
    pageDashboardBtn.addEventListener('click', () => switchPage('Dashboard'));
    viewListBtn.addEventListener('click', () => switchView('list'));
    viewKanbanBtn.addEventListener('click', () => switchView('kanban'));
    
    addChamadoBtn.addEventListener('click', () => {
        modalTitle.textContent = "Abrir Novo Chamado";
        addEditForm.reset();
        addEditForm['edit-id'].value = '';
        addEditModal.classList.remove('hidden');
    });

    appWrapper.addEventListener('click', (e) => {
        const button = e.target.closest('.action-btn');
        if (!button) return;
        const id = parseInt(button.dataset.id);

        if (button.classList.contains('delete-btn')) {
            confirmDelete.dataset.id = id;
            deleteModal.classList.remove('hidden');
        } else if (button.classList.contains('edit-btn')) {
            modalTitle.textContent = "Editar Chamado";
            const item = JSON.parse(button.dataset.item);
            addEditForm.elements['edit-id'].value = item.id;
            addEditForm.elements['edit-nomeCliente'].value = item.nomeCliente;
            addEditForm.elements['edit-telefone'].value = item.telefone;
            addEditForm.elements['edit-email'].value = item.email;
            addEditForm.elements['edit-tipo'].value = item.tipo;
            addEditForm.elements['edit-descricao'].value = item.descricao;
            addEditModal.classList.remove('hidden');
        } else if (button.classList.contains('view-details-btn')) {
            const chamado = allChamados.find(c => c.id === id);
            if (chamado) {
                const statusInfo = getStatusInfo(chamado.status);
                detailsModalContent.innerHTML = `
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
                        <div><strong>Cód. Chamado:</strong> <span class="text-gray-400 font-mono">${chamado.codigoChamado}</span></div>
                        <div><strong>Status:</strong> <span class="status-badge ${statusInfo.class}">${statusInfo.text}</span></div>
                        <div><strong>Cliente:</strong> <span class="text-gray-400">${chamado.nomeCliente}</span></div>
                        <div><strong>Telefone:</strong> <span class="text-gray-400">${chamado.telefone || 'N/A'}</span></div>
                        <div><strong>E-mail:</strong> <span class="text-gray-400">${chamado.email || 'N/A'}</span></div>
                        <div><strong>Data de Abertura:</strong> <span class="text-gray-400">${new Date(chamado.dataAbertura).toLocaleString('pt-BR')}</span></div>
                        <div><strong>Data de Conclusão:</strong> <span class="text-gray-400">${chamado.dataConclusao ? new Date(chamado.dataConclusao).toLocaleString('pt-BR') : 'Pendente'}</span></div>
                        <div class="sm:col-span-2"><strong>Tempo para Resolução:</strong> <span class="text-gray-400">${calculateResolutionTime(chamado.dataAbertura, chamado.dataConclusao)}</span></div>
                    </div>
                    <hr class="my-3" style="border-color: var(--border-color);">
                    <div><strong>Descrição do Problema:</strong></div>
                    <p class="text-gray-400 whitespace-pre-wrap p-2 rounded" style="background-color: var(--bg-primary);">${chamado.descricao}</p>`;
                detailsModal.classList.remove('hidden');
            }
        }
    });

    chamadosList.addEventListener('change', async (e) => {
        if (e.target.classList.contains('status-changer')) {
            const id = parseInt(e.target.dataset.id);
            const newStatus = e.target.value;
            try {
                const dataToUpdate = { status: newStatus };
                const chamadoAtual = allChamados.find(c => c.id === id);
                if (newStatus === 'Resolvido' && !chamadoAtual.dataConclusao) {
                    dataToUpdate.dataConclusao = new Date().toISOString();
                }
                if (newStatus !== 'Resolvido') {
                    dataToUpdate.dataConclusao = null;
                }
                await api.patchChamado(id, dataToUpdate);
                await loadData();
            } catch (error) {
                console.error("Erro ao atualizar status:", error);
            }
        }
    });

    addEditForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = addEditForm['edit-id'].value ? parseInt(addEditForm['edit-id'].value) : null;
        const data = {
            nomeCliente: addEditForm['edit-nomeCliente'].value,
            telefone: addEditForm['edit-telefone'].value,
            email: addEditForm['edit-email'].value,
            tipo: addEditForm['edit-tipo'].value,
            descricao: addEditForm['edit-descricao'].value
        };
        try {
            if (id) {
                await api.patchChamado(id, data);
            } else {
                data.codigoChamado = generateChamadoCode();
                data.dataAbertura = new Date().toISOString();
                data.status = 'Pendente';
                data.dataConclusao = null;
                await api.postChamado(data);
            }
            addEditModal.classList.add('hidden');
            await loadData();
        } catch (error) {
            console.error("Erro ao salvar chamado:", error);
        }
    });

    confirmDelete.addEventListener('click', async (e) => {
        const id = parseInt(e.currentTarget.dataset.id);
        try {
            await api.deleteChamado(id);
            deleteModal.classList.add('hidden');
            await loadData();
        } catch (error) {
            console.error("Erro ao apagar chamado:", error);
        }
    });

    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const user = document.getElementById('username').value;
        const pass = document.getElementById('password').value;
        if (user === 'admin' && pass === 'lumi10') {
            loginPage.classList.add('hidden');
            appWrapper.classList.remove('hidden');
        } else {
            alert('Usuário ou senha inválidos!');
        }
    });

    logoutBtn.addEventListener('click', () => logoutModal.classList.remove('hidden'));
    cancelLogout.addEventListener('click', () => logoutModal.classList.add('hidden'));
    confirmLogout.addEventListener('click', () => {
        logoutModal.classList.add('hidden');
        appWrapper.classList.add('hidden');
        loginPage.classList.remove('hidden');
        loginForm.reset();
    });

    const applyTheme = (theme) => {
        document.documentElement.classList.toggle('light-theme', theme === 'light');
        document.documentElement.classList.toggle('dark-theme', theme === 'dark');
        sunIcon.classList.toggle('hidden', theme === 'dark');
        moonIcon.classList.toggle('hidden', theme === 'light');
        localStorage.setItem('theme', theme);
        const isDarkMode = theme !== 'light';
        Chart.defaults.color = isDarkMode ? '#e2e8f0' : '#475569';
        Chart.defaults.borderColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        if(allChamados.length) applyFiltersAndRender();
    };

    themeToggleBtn.addEventListener('click', () => applyTheme(localStorage.getItem('theme') === 'dark' ? 'light' : 'dark'));

    [searchCodigoChamadoInput, searchChamadoInput, filterTipo, filterStatus, dashboardFilterStartDate, dashboardFilterEndDate].forEach(el => el.addEventListener('input', applyFiltersAndRender));
    
    dashboardFilterButtons.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        document.querySelectorAll('#dashboardFilterButtons button').forEach(b => b.classList.remove('filter-btn-active'));
        btn.classList.add('filter-btn-active');
        const period = btn.dataset.period;
        const endDate = new Date();
        let startDate = new Date();
        if(period === 'week') {
            startDate.setDate(endDate.getDate() - 6);
        } else if(period === 'month') {
            startDate.setDate(endDate.getDate() - 29);
        }
        dashboardFilterStartDate.value = startDate.toISOString().split('T')[0];
        dashboardFilterEndDate.value = endDate.toISOString().split('T')[0];
        applyFiltersAndRender();
    });
    
    cancelEdit.addEventListener('click', () => addEditModal.classList.add('hidden'));
    cancelDelete.addEventListener('click', () => deleteModal.classList.add('hidden'));
    closeDetailsModalBtn.addEventListener('click', () => detailsModal.classList.add('hidden'));
    
    generateReportBtn.addEventListener('click', () => reportModal.classList.remove('hidden'));
    cancelReportBtn.addEventListener('click', () => reportModal.classList.add('hidden'));
    
    reportForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const startDate = document.getElementById('reportStartDate').value;
        const endDate = document.getElementById('reportEndDate').value;
        const typeFilter = document.getElementById('reportTypeFilter').value;
        const statusFilter = document.getElementById('reportStatusFilter').value;
        generatePdfReport(startDate, endDate, typeFilter, statusFilter);
        reportModal.classList.add('hidden');
    });
    
    function generatePdfReport(start, end, type, status) {
        const doc = new jsPDF();
        const startDate = new Date(start + 'T00:00:00');
        const endDate = new Date(end + 'T23:59:59');
        let filteredData = allChamados.filter(c => {
            const dataAbertura = new Date(c.dataAbertura);
            const typeMatch = type === 'todos' || c.tipo === type;
            const statusMatch = status === 'todos' || c.status === status;
            return dataAbertura >= startDate && dataAbertura <= endDate && typeMatch && statusMatch;
        });
        doc.setFontSize(18);
        doc.text("Relatório de Chamados - Lumi Suporte", 14, 22);
        doc.setFontSize(11);
        doc.text(`Período: ${startDate.toLocaleDateString('pt-BR')} a ${endDate.toLocaleDateString('pt-BR')}`, 14, 30);
        doc.text(`Filtro de Tipo: ${type}`, 14, 36);
        doc.text(`Filtro de Status: ${status}`, 14, 42);
        const resolvidos = filteredData.filter(c => c.status === 'Resolvido');
        const tempos = resolvidos.map(c => calculateResolutionTime(c.dataAbertura, c.dataConclusao, true)).filter(t => t !== null);
        const tempoMedio = tempos.length > 0 ? (tempos.reduce((a, b) => a + b, 0) / tempos.length).toFixed(1) : 0;
        doc.setFontSize(12);
        doc.text("Resumo do Período", 14, 55);
        doc.setFontSize(10);
        doc.text(`- Total de Chamados: ${filteredData.length}`, 16, 61);
        doc.text(`- Chamados Resolvidos: ${resolvidos.length}`, 16, 66);
        doc.text(`- Tempo Médio de Resolução: ${tempoMedio} dias`, 16, 71);
        doc.autoTable({
            startY: 80,
            head: [['Cód.', 'Cliente', 'Tipo', 'Abertura', 'Status', 'Resolução (dias)']],
            body: filteredData.map(c => [
                c.codigoChamado, c.nomeCliente, c.tipo,
                new Date(c.dataAbertura).toLocaleDateString('pt-BR'),
                c.status,
                calculateResolutionTime(c.dataAbertura, c.dataConclusao)
            ]),
            theme: 'grid'
        });
        doc.save(`relatorio-chamados-${new Date().toISOString().split('T')[0]}.pdf`);
    }

    reiniciarChatBtn.addEventListener('click', () => {
        const iframe = document.getElementById('typebot-iframe');
        if (iframe) {
            iframe.src = iframe.src;
        }
    });

    const clearFilters = () => {
        searchCodigoChamadoInput.value = '';
        searchChamadoInput.value = '';
        filterTipo.value = 'todos';
        filterStatus.value = 'todos';
    };
    
    updateListBtn.addEventListener('click', () => {
        clearFilters();
        loadData();
    });

    applyTheme(localStorage.getItem('theme') || 'dark');
    loadData();
    switchPage('Atendente');
    
    let draggedCard = null;
    kanbanViewContainer.addEventListener('dragstart', (e) => {
        if (e.target.classList.contains('kanban-card')) {
            draggedCard = e.target;
            e.dataTransfer.setData('text/plain', e.target.dataset.id);
            setTimeout(() => e.target.classList.add('dragging'), 0);
        }
    });
    kanbanViewContainer.addEventListener('dragend', (e) => {
        if (draggedCard) {
            draggedCard.classList.remove('dragging');
            draggedCard = null;
        }
    });
    
    [kanbanColPendente, kanbanColAndamento, kanbanColResolvido].forEach(col => {
        col.parentElement.addEventListener('dragover', (e) => {
            e.preventDefault();
            col.parentElement.classList.add('drag-over');
        });
        col.parentElement.addEventListener('dragleave', (e) => {
            col.parentElement.classList.remove('drag-over');
        });
        col.parentElement.addEventListener('drop', async (e) => {
            e.preventDefault();
            col.parentElement.classList.remove('drag-over');
            const id = parseInt(e.dataTransfer.getData('text/plain'));
            const newStatus = col.parentElement.dataset.status;
            const chamado = allChamados.find(c => c.id === id);
            
            if (chamado && chamado.status !== newStatus) {
                try {
                    const dataToUpdate = { status: newStatus };
                    if (newStatus === 'Resolvido' && !chamado.dataConclusao) {
                        dataToUpdate.dataConclusao = new Date().toISOString();
                    }
                    if (newStatus !== 'Resolvido') {
                        dataToUpdate.dataConclusao = null;
                    }
                    await api.patchChamado(id, dataToUpdate);
                    await loadData();
                } catch (error) {
                    loadData();
                }
            }
        });
    });
</script>
</body>
</html>